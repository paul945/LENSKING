<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <!-- è‡ªå‹•åŒ–å‹•ä½œ 1ï¼šä»˜æ¬¾æˆåŠŸç™¼é€ LINE é€šçŸ¥çµ¦å®¢æˆ¶ -->
        <record id="action_ecpay_payment_success_notify_customer" model="base.automation">
            <field name="name">ç¶ ç•Œä»˜æ¬¾æˆåŠŸ - é€šçŸ¥å®¢æˆ¶</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="active" eval="True"/>
            
            <!-- è§¸ç™¼æ¢ä»¶ï¼špayment_state è®Šæ›´ç‚º 'paid' -->
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('payment_state', '=', 'paid')]</field>
            <field name="filter_pre_domain">[('payment_state', '!=', 'paid')]</field>
            
            <!-- åŸ·è¡Œçš„ç¨‹å¼ç¢¼ -->
            <field name="code">
# é€™è£¡æ•´åˆ LINE Bot API ç™¼é€é€šçŸ¥
# 
# ç¯„ä¾‹è¨Šæ¯ï¼š
# """
# ğŸ‰ ä»˜æ¬¾æˆåŠŸï¼
# 
# è¨‚å–®ç·¨è™Ÿï¼š{record.name}
# ä»˜æ¬¾é‡‘é¡ï¼šNT$ {record.amount_total}
# ä»˜æ¬¾æ™‚é–“ï¼š{record.payment_date}
# 
# ğŸ“… å–ä»¶è³‡è¨Š
# æ—¥æœŸï¼š{record.rental_start_date}
# åœ°é»ï¼šæ¡ƒåœ’å¸‚ä¸­å£¢å€ç¾©æ°‘è·¯ä¸€æ®µ129è™Ÿ
# 
# æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼
# """

# æš«æ™‚ç”¨ Email é€šçŸ¥ï¼ˆä¹‹å¾Œæ”¹æˆ LINEï¼‰
if record.line_user_id:
    # å¦‚æœæœ‰ LINE User IDï¼Œä¹‹å¾Œæ•´åˆ LINE Bot API
    log('TODO: ç™¼é€ LINE é€šçŸ¥çµ¦å®¢æˆ¶')
else:
    # ç™¼é€ Email
    if record.partner_id.email:
        template = env.ref('ecpay_payment_integration.email_template_payment_success', raise_if_not_found=False)
        if template:
            template.send_mail(record.id, force_send=True)
            </field>
        </record>

        <!-- è‡ªå‹•åŒ–å‹•ä½œ 2ï¼šä»˜æ¬¾æˆåŠŸé€šçŸ¥å®¢æœæº–å‚™å™¨æ -->
        <record id="action_ecpay_payment_success_notify_staff" model="base.automation">
            <field name="name">ç¶ ç•Œä»˜æ¬¾æˆåŠŸ - é€šçŸ¥å®¢æœ</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="active" eval="True"/>
            
            <!-- è§¸ç™¼æ¢ä»¶ï¼špayment_state è®Šæ›´ç‚º 'paid' -->
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('payment_state', '=', 'paid')]</field>
            <field name="filter_pre_domain">[('payment_state', '!=', 'paid')]</field>
            
            <!-- åŸ·è¡Œçš„ç¨‹å¼ç¢¼ -->
            <field name="code">
# å»ºç«‹å¾…è¾¦äº‹é …çµ¦å®¢æœ
# æé†’æº–å‚™å™¨æ

activity_type = env.ref('mail.mail_activity_data_todo', raise_if_not_found=False)
if activity_type:
    env['mail.activity'].create({
        'activity_type_id': activity_type.id,
        'summary': f'æº–å‚™å™¨æ - {record.name}',
        'note': f"""
            <p><strong>è¨‚å–®å·²ä»˜æ¬¾ï¼Œè«‹æº–å‚™å™¨æ</strong></p>
            <ul>
                <li>è¨‚å–®ç·¨è™Ÿï¼š{record.name}</li>
                <li>å®¢æˆ¶ï¼š{record.partner_id.name}</li>
                <li>å–ä»¶æ—¥æœŸï¼š{record.rental_start_date}</li>
                <li>å™¨ææ¸…å–®ï¼šè«‹æŸ¥çœ‹è¨‚å–®æ˜ç´°</li>
            </ul>
        """,
        'res_id': record.id,
        'res_model_id': env['ir.model']._get('sale.order').id,
        'user_id': env.user.id,  # æŒ‡æ´¾çµ¦ç•¶å‰ä½¿ç”¨è€…
        'date_deadline': record.rental_start_date,
    })
            </field>
        </record>

        <!-- è‡ªå‹•åŒ–å‹•ä½œ 3ï¼šATM è™›æ“¬å¸³è™Ÿç”¢ç”Ÿå¾Œé€šçŸ¥å®¢æˆ¶ -->
        <record id="action_ecpay_atm_account_notify" model="base.automation">
            <field name="name">ATM è™›æ“¬å¸³è™Ÿç”¢ç”Ÿ - é€šçŸ¥å®¢æˆ¶</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="active" eval="True"/>
            
            <!-- è§¸ç™¼æ¢ä»¶ï¼šatm_v_account æœ‰å€¼ -->
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('atm_v_account', '!=', False)]</field>
            <field name="filter_pre_domain">[('atm_v_account', '=', False')]</field>
            
            <!-- åŸ·è¡Œçš„ç¨‹å¼ç¢¼ -->
            <field name="code">
# ç™¼é€ ATM è™›æ“¬å¸³è™Ÿè³‡è¨Šçµ¦å®¢æˆ¶
# 
# ç¯„ä¾‹è¨Šæ¯ï¼š
# """
# ğŸ¦ ATM è™›æ“¬å¸³è™Ÿ
# 
# è¨‚å–®ç·¨è™Ÿï¼š{record.name}
# éŠ€è¡Œä»£ç¢¼ï¼š{record.atm_bank_code}
# è™›æ“¬å¸³è™Ÿï¼š{record.atm_v_account}
# ç¹³è²»æœŸé™ï¼š{record.atm_expire_date}
# æ‡‰ç¹³é‡‘é¡ï¼šNT$ {record.amount_total}
# 
# âš ï¸ è«‹åœ¨æœŸé™å…§å®Œæˆè½‰å¸³
# è½‰å¸³å¾Œç³»çµ±æœƒè‡ªå‹•ç¢ºèªè¨‚å–®
# """

if record.line_user_id:
    # ä¹‹å¾Œæ•´åˆ LINE Bot API
    log('TODO: ç™¼é€ ATM è³‡è¨Šåˆ° LINE')
else:
    # æš«æ™‚ç”¨ Email
    if record.partner_id.email:
        log('ç™¼é€ ATM è³‡è¨Š Email')
            </field>
        </record>

        <!-- è‡ªå‹•åŒ–å‹•ä½œ 4ï¼šè¶…å•†ç¹³è²»ä»£ç¢¼ç”¢ç”Ÿå¾Œé€šçŸ¥å®¢æˆ¶ -->
        <record id="action_ecpay_cvs_code_notify" model="base.automation">
            <field name="name">è¶…å•†ç¹³è²»ä»£ç¢¼ç”¢ç”Ÿ - é€šçŸ¥å®¢æˆ¶</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="active" eval="True"/>
            
            <!-- è§¸ç™¼æ¢ä»¶ï¼šcvs_payment_no æœ‰å€¼ -->
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('cvs_payment_no', '!=', False)]</field>
            <field name="filter_pre_domain">[('cvs_payment_no', '=', False)]</field>
            
            <!-- åŸ·è¡Œçš„ç¨‹å¼ç¢¼ -->
            <field name="code">
# ç™¼é€è¶…å•†ç¹³è²»ä»£ç¢¼çµ¦å®¢æˆ¶
# 
# ç¯„ä¾‹è¨Šæ¯ï¼š
# """
# ğŸª è¶…å•†ç¹³è²»ä»£ç¢¼
# 
# è¨‚å–®ç·¨è™Ÿï¼š{record.name}
# ç¹³è²»ä»£ç¢¼ï¼š{record.cvs_payment_no}
# ç¹³è²»æœŸé™ï¼š{record.cvs_expire_date}
# æ‡‰ç¹³é‡‘é¡ï¼šNT$ {record.amount_total}
# 
# å¯è‡³ä»¥ä¸‹è¶…å•†ç¹³è²»ï¼š
# 7-ELEVENã€å…¨å®¶ã€èŠçˆ¾å¯Œã€OK
# 
# âš ï¸ è«‹åœ¨æœŸé™å…§å®Œæˆç¹³è²»
# """

if record.line_user_id:
    # ä¹‹å¾Œæ•´åˆ LINE Bot API
    log('TODO: ç™¼é€è¶…å•†ä»£ç¢¼åˆ° LINE')
else:
    # æš«æ™‚ç”¨ Email
    if record.partner_id.email:
        log('ç™¼é€è¶…å•†ä»£ç¢¼ Email')
            </field>
        </record>

    </data>
</odoo>
