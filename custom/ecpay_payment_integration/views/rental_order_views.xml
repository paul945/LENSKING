<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- æ“´å……ç§Ÿè³ƒè¨‚å–®è¡¨å–®è¦–åœ– -->
        <record id="view_sale_order_form_ecpay" model="ir.ui.view">
            <field name="name">sale.order.form.ecpay</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                
                <!-- åœ¨ partner_id å¾Œé¢åŠ å…¥ä»˜æ¬¾ç‹€æ…‹ -->
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="payment_state" 
                           widget="badge" 
                           decoration-success="payment_state == 'paid'"
                           decoration-warning="payment_state == 'waiting_payment'"
                           decoration-danger="payment_state == 'failed'"
                    />
                    <field name="source_channel"/>
                </xpath>

                <!-- åŠ å…¥ç¶ ç•Œä»˜æ¬¾è³‡è¨Šé ç±¤ -->
                <xpath expr="//notebook" position="inside">
                    <page string="ðŸ’³ ä»˜æ¬¾è³‡è¨Š" name="payment_info">
                        <group>
                            <group string="ç¶ ç•Œäº¤æ˜“è³‡è¨Š">
                                <field name="payment_transaction_id" readonly="1"/>
                                <field name="payment_method" readonly="1"/>
                                <field name="payment_date" readonly="1"/>
                                <field name="payment_auto_registered" readonly="1"/>
                                <field name="payment_manual_verified"/>
                            </group>
                            
                            <group string="ATM ä»˜æ¬¾è³‡è¨Š" attrs="{'invisible': [('payment_method', 'not in', ['atm', 'web_atm'])]}">
                                <field name="atm_bank_code" readonly="1"/>
                                <field name="atm_v_account" readonly="1"/>
                                <field name="atm_expire_date" readonly="1"/>
                            </group>
                            
                            <group string="è¶…å•†ä»˜æ¬¾è³‡è¨Š" attrs="{'invisible': [('payment_method', 'not in', ['cvs', 'barcode'])]}">
                                <field name="cvs_payment_no" readonly="1"/>
                                <field name="cvs_expire_date" readonly="1"/>
                            </group>
                            
                            <group string="LINE æ•´åˆ">
                                <field name="line_user_id"/>
                            </group>
                        </group>
                        
                        <group>
                            <field name="payment_note" colspan="2"/>
                        </group>
                        
                        <div class="oe_button_box" name="button_box">
                            <button name="action_send_payment_link" 
                                    type="object" 
                                    string="ç™¼é€ä»˜æ¬¾é€£çµ"
                                    class="oe_stat_button" 
                                    icon="fa-link"
                                    attrs="{'invisible': [('payment_state', 'in', ['paid', 'waiting_payment'])]}"/>
                            
                            <button name="action_verify_payment_manually" 
                                    type="object" 
                                    string="äººå·¥è¦†æ ¸"
                                    class="oe_stat_button" 
                                    icon="fa-check"
                                    attrs="{'invisible': ['|', ('payment_state', '!=', 'paid'), ('payment_manual_verified', '=', True)]}"/>
                        </div>
                    </page>
                </xpath>

            </field>
        </record>

        <!-- æ“´å……ç§Ÿè³ƒè¨‚å–®æ¨¹ç‹€è¦–åœ– -->
        <record id="view_sale_order_tree_ecpay" model="ir.ui.view">
            <field name="name">sale.order.tree.ecpay</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_tree"/>
            <field name="arch" type="xml">
                
                <!-- åœ¨ç‹€æ…‹æ¬„ä½å¾Œé¢åŠ å…¥ä»˜æ¬¾ç‹€æ…‹ -->
                <xpath expr="//field[@name='state']" position="after">
                    <field name="payment_state" 
                           widget="badge"
                           decoration-success="payment_state == 'paid'"
                           decoration-warning="payment_state == 'waiting_payment'"
                           decoration-danger="payment_state == 'failed'"
                    />
                </xpath>

            </field>
        </record>

        <!-- æ“´å……æœå°‹è¦–åœ– -->
        <record id="view_sale_order_search_ecpay" model="ir.ui.view">
            <field name="name">sale.order.search.ecpay</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_sales_order_filter"/>
            <field name="arch" type="xml">
                
                <!-- åŠ å…¥ä»˜æ¬¾ç‹€æ…‹ç¯©é¸ -->
                <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                    <separator/>
                    <filter string="æœªä»˜æ¬¾" name="not_paid" domain="[('payment_state', '=', 'not_paid')]"/>
                    <filter string="ç­‰å¾…ä»˜æ¬¾" name="waiting_payment" domain="[('payment_state', '=', 'waiting_payment')]"/>
                    <filter string="å·²ä»˜æ¬¾" name="paid" domain="[('payment_state', '=', 'paid')]"/>
                    <filter string="ä»˜æ¬¾å¤±æ•—" name="failed" domain="[('payment_state', '=', 'failed')]"/>
                    <separator/>
                    <filter string="LINE Bot è¨‚å–®" name="line_bot" domain="[('source_channel', '=', 'line_bot')]"/>
                    <filter string="è‡ªå‹•å°å¸³" name="auto_registered" domain="[('payment_auto_registered', '=', True)]"/>
                </xpath>

                <!-- åŠ å…¥ç¾¤çµ„ -->
                <xpath expr="//group" position="inside">
                    <filter string="ä»˜æ¬¾ç‹€æ…‹" name="group_payment_state" context="{'group_by': 'payment_state'}"/>
                    <filter string="ä»˜æ¬¾æ–¹å¼" name="group_payment_method" context="{'group_by': 'payment_method'}"/>
                    <filter string="è¨‚å–®ä¾†æº" name="group_source_channel" context="{'group_by': 'source_channel'}"/>
                </xpath>

            </field>
        </record>

    </data>
</odoo>
