# 綠界付款整合模組 (ECPay Payment Integration)

## 📋 模組資訊

**模組名稱：** ecpay_payment_integration  
**版本：** 16.0.1.0.0  
**適用 Odoo 版本：** 16.0  
**專案：** 時光幻鏡攝影器材租借系統  
**開發日期：** 2026/02/11

---

## 🎯 功能特色

### ✅ 自動對帳
- 客戶付款後，系統自動更新訂單狀態為「已付款」
- **完全不需要人工確認付款**
- 自動建立會計付款記錄
- 完整的付款日誌追蹤

### 💳 支援多種付款方式
- ✅ 信用卡
- ✅ 信用卡分期
- ✅ WebATM
- ✅ ATM 轉帳（虛擬帳號）
- ✅ 超商代碼
- ✅ 超商條碼
- ✅ Apple Pay
- ✅ Google Pay
- ✅ LINE Pay

### 🔔 自動通知
- 付款成功 → 自動通知客戶（LINE Bot / Email）
- 付款成功 → 自動建立客服待辦事項
- ATM 虛擬帳號產生 → 自動發送給客戶
- 超商繳費代碼產生 → 自動發送給客戶

### 📊 訂單管理
- 付款狀態即時更新
- 綠界交易資訊完整記錄
- 支援人工覆核功能
- 訂單來源追蹤（LINE Bot / 官網 / 電話）

---

## 📦 安裝步驟

### 方法 1：透過 Odoo.sh（推薦）

#### Step 1：上傳模組到 Git Repository

1. **連接到您的 Odoo.sh Git Repository**
```bash
# 複製 Repository URL（從 Odoo.sh 後台取得）
git clone https://your-instance.odoo.sh/your-repo.git

cd your-repo
```

2. **建立 custom 資料夾（如果還沒有）**
```bash
mkdir -p custom
```

3. **將模組複製到 custom 資料夾**
```bash
# 將整個 ecpay_payment_integration 資料夾複製到 custom/
cp -r /path/to/ecpay_payment_integration custom/
```

4. **提交並推送到 Git**
```bash
git add custom/ecpay_payment_integration
git commit -m "Add ECPay payment integration module"
git push origin main
```

5. **等待 Odoo.sh 自動部署**
- Odoo.sh 會自動偵測新模組
- 等待約 5-10 分鐘完成部署

#### Step 2：在 Odoo 中安裝模組

1. **進入 Odoo 後台**
   - 登入：https://paul945-lensking.odoo.com
   - 使用管理員帳號

2. **更新應用程式清單**
   - 設定 → 應用程式 → 更新應用程式清單

3. **搜尋並安裝模組**
   - 搜尋：「綠界」或 「ECPay」
   - 點選「安裝」

4. **等待安裝完成**
   - 系統會自動安裝依賴模組
   - 安裝完成後會自動套用設定

---

## ⚙️ 設定步驟

### 1. 檢查系統參數（已自動設定）

進入：**設定 → 技術 → 系統參數**

檢查以下參數是否正確：

| 參數名稱 | 值 | 說明 |
|---------|-----|------|
| ecpay.merchant_id | 3031219 | 您的綠界特店編號（正式環境） |
| ecpay.hash_key | VRnWnVYzZiMiL5KU | HashKey（正式環境） |
| ecpay.hash_iv | aymWrNfsJXa83Zfb | HashIV（正式環境） |
| ecpay.test_mode | False | 測試模式（False=正式，True=測試） |

**⚠️ 測試時請修改：**
- 將 `ecpay.test_mode` 改為 `True`
- 將 `ecpay.merchant_id` 改為 `2000132`
- 將 `ecpay.hash_key` 改為 `5294y06JbISpM5x9`
- 將 `ecpay.hash_iv` 改為 `v77hoKGq4kWxNNIS`

### 2. 設定綠界回調網址

登入綠界特店後台：https://vendor.ecpay.com.tw/

進入：**系統設定 → 系統介接設定**

設定以下網址：

```
ReturnURL（付款完成通知）：
https://paul945-lensking.odoo.com/ecpay/payment/notify

PaymentInfoURL（ATM/超商通知）：
https://paul945-lensking.odoo.com/ecpay/atm/notify

ClientBackURL（客戶返回網址）：
https://www.lensking.com.tw
```

**✅ 完成後點選「儲存」**

---

## 🧪 測試流程

### 測試環境設定

1. **切換到測試模式**
   - 系統參數 → ecpay.test_mode → 改為 `True`
   - 重新啟動 Odoo（如需要）

2. **建立測試訂單**
   - 銷售 → 訂單 → 建立
   - 填入測試資料
   - 儲存訂單

3. **產生測試付款連結**
   - 打開剛建立的訂單
   - 點選「💳 付款資訊」頁籤
   - 點選「發送付款連結」按鈕
   - 複製付款連結

4. **測試付款**
   - 開啟付款連結
   - 選擇付款方式
   - 使用測試卡號付款

**綠界測試卡號：**
```
信用卡號：4311-9522-2222-2222
有效期限：任意未來日期（例如：12/30）
安全碼：任意3碼（例如：222）
```

5. **確認自動對帳**
   - 回到 Odoo 訂單頁面
   - 重新整理頁面
   - 確認「付款狀態」已變更為「已付款」✅
   - 檢查「💳 付款資訊」頁籤的交易資訊

### 測試 ATM 付款

1. 選擇「ATM 轉帳」付款方式
2. 系統會產生虛擬帳號
3. 在 Odoo 訂單中應該會看到：
   - 付款狀態：等待付款
   - ATM 銀行代碼
   - ATM 虛擬帳號
   - 繳費期限

4. 綠界測試環境會自動模擬付款完成
5. 訂單狀態會自動更新為「已付款」

---

## 📊 使用說明

### 訂單付款流程

#### 1. 客戶下單（透過 LINE Bot 或人工）
```
建立租賃訂單
    ↓
訂單狀態：草稿 (draft)
付款狀態：未付款 (not_paid)
```

#### 2. 發送付款連結
```
方法 A：點選「發送付款連結」按鈕
方法 B：透過 LINE Bot 自動發送
    ↓
系統產生綠界付款連結
    ↓
付款狀態：處理中 (pending)
```

#### 3. 客戶選擇付款方式

**選項 A：信用卡（即時完成）**
```
客戶輸入卡號付款
    ↓
綠界立即回調 /ecpay/payment/notify
    ↓
系統自動更新：
  - 訂單狀態：已確認 (sale)
  - 付款狀態：已付款 (paid)
  - 建立付款記錄
  - 發送通知
```

**選項 B：ATM 轉帳（分兩階段）**
```
第一階段：取得虛擬帳號
    ↓
綠界回調 /ecpay/atm/notify (RtnCode=2)
    ↓
系統記錄虛擬帳號資訊
    ↓
付款狀態：等待付款 (waiting_payment)
    ↓
發送虛擬帳號給客戶

第二階段：客戶完成轉帳
    ↓
綠界回調 /ecpay/atm/notify (RtnCode=1)
    ↓
系統自動更新為已付款
```

**選項 C：超商代碼（類似 ATM）**
```
取得繳費代碼
    ↓
發送給客戶
    ↓
客戶至超商繳費
    ↓
自動更新為已付款
```

### 查看付款資訊

1. **打開任一訂單**
2. **點選「💳 付款資訊」頁籤**
3. **可以看到：**
   - 綠界交易編號
   - 付款方式
   - 付款時間
   - 是否自動登記
   - ATM/超商資訊（如適用）

### 篩選訂單

在訂單列表頁面，可以使用以下篩選：

- **未付款** - 顯示所有未付款訂單
- **等待付款** - ATM/超商已取號，等待繳費
- **已付款** - 已完成付款的訂單
- **付款失敗** - 付款過程失敗的訂單
- **LINE Bot 訂單** - 從 LINE Bot 建立的訂單
- **自動對帳** - 系統自動登記的付款

---

## 🔔 自動化動作說明

### 1. 付款成功 → 通知客戶

**觸發條件：** 付款狀態變更為「已付款」

**執行動作：**
- 發送 LINE 通知（如有 LINE User ID）
- 或發送 Email（如無 LINE）

**訊息範例：**
```
🎉 付款成功！

訂單編號：RO202602110001
付款金額：NT$ 4,500
付款時間：2026/02/11 14:30

📅 取件資訊
日期：2026/02/15（星期六）
時間：12:00 以後
地點：桃園市中壢區義民路一段129號

期待您的光臨！
```

### 2. 付款成功 → 通知客服

**觸發條件：** 付款狀態變更為「已付款」

**執行動作：**
- 建立待辦事項 (Activity)
- 指派給客服人員
- 提醒準備器材

### 3. ATM 虛擬帳號 → 通知客戶

**觸發條件：** ATM 虛擬帳號產生

**執行動作：**
- 發送虛擬帳號資訊給客戶

### 4. 超商代碼 → 通知客戶

**觸發條件：** 超商繳費代碼產生

**執行動作：**
- 發送繳費代碼給客戶

---

## 🔧 進階功能

### 人工覆核

如果需要人工確認付款：

1. 打開訂單
2. 進入「💳 付款資訊」頁籤
3. 點選「人工覆核」按鈕
4. 系統會標記為「已覆核」

### 產生付款連結（手動）

如果需要重新發送付款連結：

1. 打開訂單
2. 點選「發送付款連結」按鈕
3. 複製連結發送給客戶

### 查看付款日誌

在訂單的「訊息」(Chatter) 區域可以看到：
- 付款成功通知
- ATM/超商資訊通知
- 所有付款相關的系統記錄

---

## 🐛 常見問題排除

### Q1: 付款後訂單狀態沒有更新？

**可能原因：**
1. 綠界回調網址設定錯誤
2. 檢查碼驗證失敗
3. 訂單編號不符

**排除步驟：**
1. 檢查綠界後台的回調網址設定
2. 檢查 Odoo 日誌：設定 → 技術 → 日誌記錄
3. 搜尋關鍵字：「綠界」或「ECPay」
4. 查看錯誤訊息

### Q2: 找不到「綠界付款整合」模組？

**排除步驟：**
1. 確認模組已正確上傳到 Git
2. 更新應用程式清單：設定 → 應用程式 → 更新應用程式清單
3. 移除搜尋篩選，顯示所有應用程式
4. 搜尋「綠界」或「ECPay」

### Q3: 測試付款一直失敗？

**確認事項：**
1. 確認 ecpay.test_mode = True
2. 確認使用測試環境的 MerchantID、HashKey、HashIV
3. 確認使用測試卡號：4311-9522-2222-2222
4. 檢查網路連線

### Q4: 如何切換到正式環境？

**步驟：**
1. 系統參數 → ecpay.test_mode → 改為 `False`
2. 系統參數 → ecpay.merchant_id → 改為 `3031219`
3. 系統參數 → ecpay.hash_key → 改為 `VRnWnVYzZiMiL5KU`
4. 系統參數 → ecpay.hash_iv → 改為 `aymWrNfsJXa83Zfb`
5. 確認綠界後台回調網址正確

---

## 📞 技術支援

### Odoo 相關問題
- Odoo.sh 後台支援系統

### 綠界相關問題
- 綠界客服：02-2655-0115

### 專案聯絡人
- 負責人：蔡政良
- Email：paul945@gmail.com
- 電話：0905527577

---

## 📝 版本更新記錄

### v16.0.1.0.0 (2026/02/11)
- ✅ 初始版本發布
- ✅ 支援信用卡、ATM、超商付款
- ✅ 自動對帳功能
- ✅ 自動化通知
- ✅ 完整的付款日誌

---

## 🔒 安全性提醒

1. **HashKey 和 HashIV 請妥善保管**
   - 不要分享給未授權人員
   - 定期更換（建議每年）

2. **測試與正式環境分離**
   - 測試時使用測試環境金鑰
   - 正式環境務必使用正式金鑰

3. **定期檢查日誌**
   - 注意異常的付款通知
   - 檢查是否有可疑的回調請求

4. **備份設定**
   - 定期備份系統參數
   - 記錄所有設定變更

---

## 📄 授權資訊

**授權方式：** LGPL-3  
**版權所有：** 時光幻鏡 © 2026  
**網站：** https://www.lensking.com.tw

---

**祝您使用順利！** 🎉

如有任何問題，請隨時聯絡技術支援團隊。
